<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.keconnection.address.strategy.building.KeConnectionBuilding">

    <select id="getBuildingOrganizationAssociations" parameterType="map" 
                resultType="org.complitex.keconnection.address.strategy.building.entity.BuildingOrganizationAssociation">
        SELECT `id` id, `organization_id` organizationId, `code` buildingCode, `building_id` buildingId
        FROM `building_code` WHERE `id` IN 
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>
    
    <insert id="insertBuildingOrganizationAssociation" 
    parameterType="org.complitex.keconnection.address.strategy.building.entity.BuildingOrganizationAssociation"
                useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `building_code` (`organization_id`, `code`, `building_id`) 
            VALUES (#{organizationId}, #{buildingCode}, #{buildingId})
    </insert>
    
    <delete id="deleteBuildingOrganizationAssociations" parameterType="map">
        DELETE FROM `building_code` WHERE `id` IN 
            (SELECT a.`value_id` FROM `building_attribute` a WHERE a.`object_id` = #{objectId} 
                AND a.`attribute_type_id` = #{buildingOrganizationAssociationsAT})
    </delete>

    <select id="selectBuildingCodeId" parameterType="map" resultType="long">
        select `id` from `building_code` where `organization_id` = #{organizationId} and `code` = #{buildingCode}
    </select>
</mapper>
