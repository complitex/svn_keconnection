<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.keconnection.address.service.KeConnectionBuildingImportBean">
    
    <resultMap id="buildingImport" type="org.complitex.keconnection.address.entity.BuildingImport">
        <id column="id" property="id"/>
        <result column="distr_id" property="distrId"/>
        <result column="street_id" property="streetId"/>
        <result column="num" property="num"/>
        <result column="part" property="part"/>
        <result column="processed" property="processed"/>
        <collection property="buildingParts" ofType="org.complitex.keconnection.address.entity.BuildingPartImport">
            <id column="part_id" property="id"/>
            <result column="gek" property="gek"/>
            <result column="code" property="code"/>
            <result column="building_import_id" property="buildingImportId"/>
        </collection>
    </resultMap>

    <select id="findId" parameterType="map" resultType="long">
        SELECT `id` FROM `building_import` WHERE `street_id` = #{streetId} AND `num` = #{num} AND `part` = #{part} 
        LIMIT 0,1
    </select>
    
    <select id="find" parameterType="int" 
                resultMap="org.complitex.keconnection.address.service.KeConnectionBuildingImportBean.buildingImport">
        SELECT b.*, p.`id` part_id, p.`gek`, p.`code`, p.`building_import_id`
        FROM (SELECT b.* FROM `building_import` b WHERE b.`processed` = 0 LIMIT 0, ${value}) b
        LEFT OUTER JOIN `building_part_import` p ON p.`building_import_id` = b.`id`
    </select>
    
    <update id="markProcessed" parameterType="long">
        UPDATE `building_import` SET `processed` = 1 WHERE `id` = #{id}
    </update>
    
    <insert id="insertPart" parameterType="org.complitex.keconnection.address.entity.BuildingPartImport">
        INSERT INTO `building_part_import` (`id`, `gek`, `code`, `building_import_id`) 
            VALUES (#{id}, #{gek}, #{code}, #{buildingImportId})
    </insert>
    
    <insert id="insert" parameterType="org.complitex.keconnection.address.entity.BuildingImport"
                useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `building_import` (`distr_id`, `street_id`, `num`, `part`) 
            VALUES (#{distrId}, #{streetId}, #{num}, #{part})
    </insert>
    
    <delete id="deleteParts">
        DELETE FROM `building_part_import`
    </delete>
    
    <delete id="delete">
        DELETE FROM `building_import`
    </delete>

</mapper>
