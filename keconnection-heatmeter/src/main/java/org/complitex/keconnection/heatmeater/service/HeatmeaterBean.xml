<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.keconnection.heatmeater.service.HeatmeaterBean">
    <resultMap id="heatmeaterResultMap" type="org.complitex.keconnection.heatmeater.entity.Heatmeater">
        <id property="id" column="id"/>
        <result property="ls" column="ls"/>
        <result property="type" column="type_id"/>
        <result property="buildingCodeId" column="building_code_id"/>
        <result property="status"/>
        <collection property="periods"
                    select="org.complitex.keconnection.heatmeater.service.HeatmeaterPeriodBean.selectHeatmeaterPeriodsByHeatmeterId"
                    column="id"/>
    </resultMap>

    <insert id="insertHeatmeater" parameterType="org.complitex.keconnection.heatmeater.entity.Heatmeater"
            useGeneratedKeys="true" keyProperty="id">
        insert into `heatmeater` (`ls`, `type_id`, `building_code_id`)
          values (#{ls}, #{type}, #{buildingCodeId})
    </insert>

    <update id="updateHeatmeater" parameterType="org.complitex.keconnection.heatmeater.entity.Heatmeater">
        update `heatmeater` set `ls` = #{ls}, `type_id` = #{type}, `building_code_id` = #{buildingCodeId}
    </update>

    <select id="selectHeatmeater" parameterType="long" resultMap="heatmeaterResultMap">
        select h.*, (select `type_id` from `heatmeater_period` where `end_date` is null
          and `heatmeater_id` = h.`id` order by `begin_date` desc limit 1) as `status`
        from `heatmeater` h where `id` = #{id}
    </select>

    <sql id="selectHeatmeatersWhere">
        <where>
            <if test="object.ls != null">`ls` = #{object.ls}</if>
            <if test="object.type != null">and `type_id` = #{object.type}</if>
            <if test="object.buildingCodeId != null">and `building_code_id` = #{object.buildingCodeId}</if>
            <if test="object.status != null">and `status` = #{status}</if>
        </where>
    </sql>

    <select id="selectHeatmeaters" parameterType="org.complitex.dictionary.entity.FilterWrapper"
            resultMap="heatmeaterResultMap">
        select h.*, (select `type_id` from `heatmeater_period` where `end_date` is null
          and `heatmeater_id` = h.`id` order by `begin_date` desc limit 1) as `status`
        from `heatmeater` h <include refid="selectHeatmeatersWhere"/>
        order by ${sortProperty} ${asc} limit #{first}, #{count}
    </select>

    <select id="selectHeatmeatersCount" parameterType="org.complitex.dictionary.entity.FilterWrapper"
            resultType="int">
        select count(*) from `heatmeater` <include refid="selectHeatmeatersWhere"/>
    </select>

    <delete id="deleteHeatmeater" parameterType="long">
        delete from `heatmeater` where `id` = #{id}
    </delete>

    <select id="isExistHeatmeater" parameterType="org.complitex.keconnection.heatmeater.entity.Heatmeater"
            resultType="boolean">
        select count(*) > 0 from `heatmeater` where `ls` = #{ls}
    </select>
</mapper>