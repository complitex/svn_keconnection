<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.keconnection.heatmeter.service.HeatmeterConnectionBean">
    <resultMap id="heatmeterConnectionResultMap" type="org.complitex.keconnection.heatmeter.entity.HeatmeterConnection">
        <id column="connection_id" property="id"/>
        <result property="buildingCodeId" column="building_code_id"/>
        <result property="buildingId" column="building_id"/>
        <result property="organizationId" column="organization_id"/>
        <result property="code" column="code"/>
        <association property="period" javaType="org.complitex.keconnection.heatmeter.entity.HeatmeterPeriod">
            <id column="period_id" property="id"/>
            <result property="heatmeterId" column="heatmeter_id"/>
            <result property="type" column="type"/>
            <result property="subType" column="sub_type"/>
            <result property="attributeId" column="attribute_id"/>
            <result property="beginDate" column="begin_date"/>
            <result property="endDate" column="end_date"/>
            <result property="beginOm" column="begin_om"/>
            <result property="endOm" column="end_om"/>
        </association>
    </resultMap>

    <insert id="insertHeatmeterConnection" parameterType="org.complitex.keconnection.heatmeter.entity.HeatmeterConnection"
            useGeneratedKeys="true" keyProperty="id">
        insert into `heatmeter_connection` (`building_code_id`) values (#{buildingCodeId})
    </insert>

    <update id="updateHeatmeterConnection" parameterType="org.complitex.keconnection.heatmeter.entity.HeatmeterConnection">
        update `heatmeter_connection` set `building_code_id` = #{buildingCodeId} where `id` = #{id}
    </update>

    <select id="selectHeatmeterConnection" parameterType="long" resultMap="heatmeterConnectionResultMap">
        select * from `heatmeter_connection` where `id` = #{id}
    </select>

    <select id="selectHeatmeterConnectionsByHeatmeterId" parameterType="long" resultMap="heatmeterConnectionResultMap">
        SELECT hc.`id` connection_id, hc.*, p.`id` period_id, p.*, 
            bc.`building_id`, bc.`organization_id`, bc.`code` 
        FROM `heatmeter_connection` hc
          LEFT JOIN `building_code` bc ON bc.`id` = hc.`building_code_id`
          JOIN `heatmeter_period` p ON (p.`attribute_id` =  hc.`id` AND p.`type` = 2)
          LEFT JOIN `operating_month` om ON om.`organization_id` = bc.`organization_id`
        WHERE p.`heatmeter_id` = #{heatmeterId} AND (om.`begin_om` BETWEEN p.`begin_om` AND p.`end_om`)
        ORDER BY p.`begin_date`
    </select>

    <delete id="deleteHeatmeterConnection" parameterType="long">
        delete from `heatmeter_connection` where `id` = #{id}
    </delete>
</mapper>