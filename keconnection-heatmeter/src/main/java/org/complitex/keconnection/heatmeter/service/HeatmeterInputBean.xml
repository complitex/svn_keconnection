<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.keconnection.heatmeter.service.HeatmeterInputBean">
    <resultMap id="heatmeterInputResultMap" type="org.complitex.keconnection.heatmeter.entity.HeatmeterInput">
        <id column="input_id" property="id"/>
        <result property="value" column="value"/>
        <association property="period" javaType="org.complitex.keconnection.heatmeter.entity.HeatmeterPeriod">
            <id column="period_id" property="id"/>
            <result property="heatmeterId" column="heatmeter_id"/>
            <result property="type" column="type"/>
            <result property="subType" column="sub_type"/>
            <result property="attributeId" column="attribute_id"/>
            <result property="beginDate" column="begin_date"/>
            <result property="endDate" column="end_date"/>
            <result property="beginOm" column="begin_om"/>
            <result property="endOm" column="end_om"/>
        </association>
        <collection property="consumptions" column="input_id" 
                select="org.complitex.keconnection.heatmeter.service.HeatmeterConsumptionBean.selectHeatmeterConsumptionsByHeatmeterInputId"/>
    </resultMap>
    
    <insert id="insertHeatmeterInput" parameterType="org.complitex.keconnection.heatmeter.entity.HeatmeterInput"
        useGeneratedKeys="true" keyProperty="id">
        insert into `heatmeter_input` (`value`) values (#{value})
    </insert>

    <update id="updateHeatmeterInput" parameterType="org.complitex.keconnection.heatmeter.entity.HeatmeterInput">
        update `heatmeter_input` set `value` = #{value} where `id` = #{id}
    </update>

    <select id="selectHeatmeterInputsByOm" parameterType="map" resultMap="heatmeterInputResultMap">
        SELECT hp.`id` input_id, hp.*, p.`id` period_id, p.* FROM `heatmeter_input` hp
        JOIN `heatmeter_period` p ON (p.`attribute_id` =  hp.`id` AND p.`type` = 4)
        WHERE p.`heatmeter_id` = #{heatmeterId} AND (#{om} BETWEEN p.`begin_om` AND p.`end_om`)
        ORDER BY p.`begin_date`
    </select>

    <delete id="deleteHeatmeterInput" parameterType="long">
        delete i, p from `heatmeter_input` as i join `heatmeter_period` as p on p.`attribute_id` = i.`id` and p.`type` = 4
          where i.`id` = #{id}
    </delete>
</mapper>